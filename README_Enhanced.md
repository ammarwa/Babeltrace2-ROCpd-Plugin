# Enhanced ROCm Babeltrace2 Plugin

## Overview

This enhanced ROCm Babeltrace2 plugin reads SQLite3 databases generated by rocprofv3 (ROCm profiler) and converts them into babeltrace2 trace events with **category-based stream splitting** and **channel-based organization**.

## Key Features

### 1. **Database Support**
- Uses the `24228_results.db` database with comprehensive ROCm profiling data
- Supports the enhanced table structure with UUID-based table names
- Handles multiple categories of profiling data

### 2. **Category-Based Stream Splitting**
The plugin now creates separate streams for different ROCm profiling categories:

- **HIP_RUNTIME_API_EXT**: HIP Runtime API calls (hipMemcpy, hipLaunchKernel, etc.)
- **HIP_COMPILER_API_EXT**: HIP Compiler API calls (__hipRegisterFatBinary, etc.)
- **HSA_CORE_API**: HSA Core API calls (hsa_agent_get_info, etc.)
- **HSA_AMD_EXT_API**: HSA AMD Extension API calls (hsa_amd_agent_iterate_memory_pools, etc.)
- **KERNEL_DISPATCH**: GPU kernel launches and executions
- **MARKER_CORE_API**: ROCm marker/profiling annotations
- **MEMORY_COPY**: Memory copy operations between host and device
- **MEMORY_ALLOCATION**: Memory allocation/deallocation events

### 3. **Channel-Based Organization**
Within each category, events are further organized into channels based on:

- **Thread ID**: Events from the same thread (`thread_24228`, `thread_24243`, etc.)
- **Queue ID**: Events from the same GPU queue (`queue_0`, `queue_2`, etc.)
- **Stream ID**: Events from the same GPU stream (`stream_0`, `stream_1`, etc.)

### 4. **Enhanced Event Data**
Each event contains rich metadata:
- **Timing**: Start/end timestamps with nanosecond precision
- **Context**: Process ID, thread ID, correlation IDs
- **Details**: Function names, kernel names, memory sizes, etc.
- **Categories**: Proper categorization for easy filtering

## Database Analysis Results

From the `24228_results.db` database:

```
Categories: 8 total
- HIP_COMPILER_API_EXT: 200 events across 4 threads
- HIP_RUNTIME_API_EXT: 200 events across 10 threads  
- HSA_AMD_EXT_API: 200 events across 2 threads
- HSA_CORE_API: 200 events on 1 thread
- KERNEL_DISPATCH: 100 events across 4 threads
- MARKER_CORE_API: 10 events across 4 threads
- MEMORY_COPY: 100 events across 5 threads
- MEMORY_ALLOCATION: 273 events (full dataset)

Total Data:
- 26,937 regions
- 2,072 kernel dispatches
- 72 memory copies
- 273 memory allocations
- 11 threads
- 9 queues
- 21 streams
```

## Files

### 1. `bt_plugin_rocm_enhanced.py`
The main enhanced plugin with bt2 integration (requires babeltrace2 installation).

### 2. `rocm_analyzer.py`
Standalone analyzer that demonstrates the plugin's capabilities without requiring bt2.

### 3. `test_enhanced_plugin.py`
Test script to validate database structure and plugin functionality.

## Usage

### With Babeltrace2 (requires bt2 installation):
```bash
# Install babeltrace2 first
# Then use the enhanced plugin
babeltrace2 --plugin-path=. --component=source.rocm.RocmSource \
  --params='db-path="24228_results.db"' \
  --component=sink.text.pretty
```

### Standalone Analysis:
```bash
# Run the analyzer to see stream organization
python rocm_analyzer.py

# Run tests to validate database structure
python test_enhanced_plugin.py
```

## Stream Organization Example

For HIP_RUNTIME_API_EXT category:
```
Category: HIP_RUNTIME_API_EXT
  Total events: 200
  Channels: 10
    thread_24228: 2 events (Time: 3064802383657647 - 3064802420944906)
    thread_24242: 2 events (Time: 3064802421072585 - 3064802421097151)
    thread_24243: 84 events (Time: 3064802421417685 - 3064802764530687)
    thread_24244: 24 events (Time: 3064802421440048 - 3064802758798851)
    thread_24245: 66 events (Time: 3064802421568899 - 3064802761863573)
    ...
```

## Event Examples

### HIP Runtime API Events:
```
hipSetDevice_start @ 3064802421417685 (channel: thread_24243)
hipSetDevice_end @ 3064802421430969 (channel: thread_24243)
hipMalloc_start @ 3064802421471837 (channel: thread_24243)
hipMalloc_end @ 3064802421520074 (channel: thread_24243)
```

### Kernel Dispatch Events:
```
kernel_dispatch_start @ 3064802764584985 (channel: thread_24243)
  - kernel_name: "vectorAdd"
  - dispatch_id: 1
  - queue_id: 2
  - workgroup_size: "256x1x1"
  - grid_size: "1024x1x1"
kernel_dispatch_end @ 3064802764612847 (channel: thread_24243)
```

### Memory Copy Events:
```
memory_copy_start @ 3064802630934854 (channel: thread_24243)
  - copy_name: "Memcpy HtoD"
  - size: 4194304
  - stream_id: 1
memory_copy_end @ 3064802630945182 (channel: thread_24243)
```

## Benefits

1. **Better Trace Organization**: Category-based streams make it easier to focus on specific aspects of GPU profiling
2. **Channel Separation**: Thread/queue/stream-based channels provide clear execution context
3. **Rich Event Data**: Comprehensive metadata for each event type
4. **Scalable Analysis**: Separate streams reduce noise and improve analysis performance
5. **ROCm Compatibility**: Full support for ROCm profiler categories and event types

## Next Steps

1. Install babeltrace2 to use the full plugin functionality
2. Integrate with trace viewers like Trace Compass or custom analysis tools
3. Add support for additional ROCm profiler categories as needed
4. Implement custom analysis scripts for specific use cases
