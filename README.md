# ROCm Profiler Babeltrace2 Plugin

This plugin reads SQLite3 databases generated by ROCm profiler (rocprofv3) and converts them into babeltrace2 trace events.

## Features

- **Region Events**: Reads CPU regions with start/end timestamps and duration
- **Kernel Dispatch Events**: Reads GPU kernel execution events with dispatch details, workgroup sizes, and durations
- **Memory Copy Events**: Reads memory transfer operations between agents with size and duration information
- **Sample Events**: Reads instantaneous sampling data from CPU/GPU tracks
- **Generic Events**: Fallback handling for unrecognized events
- **Automatic Detection**: Automatically detects ROCm profiler databases and handles different table naming schemes

## Requirements

- Python 3.7+
- babeltrace2 with Python bindings
- sqlite3 (standard library)

## Installation

1. Make sure you have babeltrace2 installed:
   ```bash
   # On Ubuntu/Debian
   sudo apt-get install babeltrace2 python3-babeltrace2

   # On macOS with Homebrew
   brew install babeltrace2
   ```

2. Install Python dependencies:
   ```bash
   pip install -r requirements.txt
   ```

3. Place the plugin file (`bt_plugin_rocm.py`) in a directory where babeltrace2 can find it

## Usage

### Basic Usage

```bash
# Read a ROCm profiler database and display events
babeltrace2 --plugin-path=. --component source.rocm.RocmSource --params='db-path="your_rocm_database.db"'

# Convert to text format with pretty printing
babeltrace2 --plugin-path=. --component source.rocm.RocmSource --params='db-path="your_rocm_database.db"' --component sink.text.pretty

# Convert to CTF format
babeltrace2 --plugin-path=. --component source.rocm.RocmSource --params='db-path="your_rocm_database.db"' --component sink.ctf.fs --params='path="output_ctf_trace"'
```

### Advanced Usage

```bash
# Filter events by timestamp range
babeltrace2 --plugin-path=. --component source.rocm.RocmSource --params='db-path="your_rocm_database.db"' \\
  --component filter.utils.trimmer --params='begin=1000000000,end=2000000000' \\
  --component sink.text.pretty
  -c sink.text.json
```

### Python API Usage

```python
import bt2

# Create a plugin
plugin = bt2.find_plugin("rocm")
source_cc = plugin.source_component_classes["RocmSource"]

# Create a graph
graph = bt2.Graph()

# Add source component
source = graph.add_component(source_cc, "rocm_source", {
    "db-path": "/path/to/rocm_profile.db"
})

# Add sink component
sink_cc = bt2.find_plugin("text").sink_component_classes["pretty"]
sink = graph.add_component(sink_cc, "text_sink")

# Connect components
graph.connect_ports(source.output_ports["out"], sink.input_ports["in"])

# Run the graph
graph.run()
```

## Event Types

The plugin generates the following event types:

### Region Events
- **Name**: `region_event`
- **Fields**:
  - `region_name`: Name of the region
  - `event_type`: "region_start" or "region_end"
  - `duration`: Duration in nanoseconds (for end events)

### Kernel Dispatch Events
- **Name**: `kernel_dispatch_event`
- **Fields**:
  - `kernel_name`: Name of the kernel
  - `event_type`: "kernel_dispatch_start" or "kernel_dispatch_end"
  - `dispatch_id`: Unique dispatch identifier
  - `queue_id`: Queue identifier
  - `stream_id`: Stream identifier
  - `workgroup_size`: Workgroup dimensions (e.g., "64x1x1")
  - `grid_size`: Grid dimensions (e.g., "1024x1x1")
  - `duration`: Execution duration in nanoseconds (for end events)

### Memory Copy Events
- **Name**: `memory_copy_event`
- **Fields**:
  - `copy_name`: Name of the memory operation
  - `event_type`: "memory_copy_start" or "memory_copy_end"
  - `size`: Size of the memory transfer in bytes
  - `dst_agent_id`: Destination agent identifier
  - `src_agent_id`: Source agent identifier
  - `duration`: Transfer duration in nanoseconds (for end events)

### Sample Events
- **Name**: `sample_event`
- **Fields**:
  - `track_name`: Name of the sampling track
  - `event_type`: "sample"
  - `track_id`: Track identifier

## Database Schema

The plugin expects ROCm profiler SQLite3 databases with the following key tables:

- `rocpd_region{uuid}`: CPU regions with start/end times
- `rocpd_kernel_dispatch{uuid}`: GPU kernel dispatches
- `rocpd_memory_copy{uuid}`: Memory copy operations
- `rocpd_sample{uuid}`: Sample events
- `rocpd_string{uuid}`: String table for names
- `rocpd_info_*{uuid}`: Various information tables

## Error Handling

The plugin handles various error conditions:

- **Missing database file**: Raises `FileNotFoundError`
- **Invalid database format**: Logs errors and continues with available data
- **Missing tables**: Gracefully handles missing optional tables
- **SQL errors**: Logs specific errors and continues processing

## Performance

- **Memory efficient**: Loads events in batches to handle large databases
- **Sorted output**: Events are sorted by timestamp for proper trace ordering
- **Database optimization**: Uses indexes for efficient querying

## Limitations

- Requires babeltrace2 Python bindings
- SQLite3 database must be accessible and not locked
- Large databases may require significant memory
- UUID/GUID detection is basic and may need adjustment for different rocprofv3 versions

## Contributing

To extend the plugin:

1. Add new event types by extending `_load_*_events()` methods
2. Add new event classes in `_create_event_classes()`
3. Update the event class name mapping in `_get_event_class_name()`
4. Test with various ROCm profiler database formats

## Example Output

```
[14:30:45.123456789] (+0.000000000) region_event: { region_name = "main", event_type = "region_start" }
[14:30:45.123567890] (+0.000111101) kernel_dispatch_event: { kernel_name = "vector_add", event_type = "kernel_dispatch_start", dispatch_id = 1, queue_id = 0, stream_id = 0, workgroup_size = "256x1x1", grid_size = "1024x1x1" }
[14:30:45.125678901] (+0.002111012) kernel_dispatch_event: { kernel_name = "vector_add", event_type = "kernel_dispatch_end", dispatch_id = 1, duration = 2111011 }
[14:30:45.126789012] (+0.003221123) region_event: { region_name = "main", event_type = "region_end", duration = 3221123 }
```
