# ROCm Profiler Babeltrace2 Plugin

This plugin reads SQLite3 databases generated by ROCm profiler (rocprofv3) and converts them into babeltrace2 trace events.

## Features

- **Region Events**: Reads CPU regions with start/end timestamps and duration
- **Kernel Dispatch Events**: Reads GPU kernel execution events with dispatch details, workgroup sizes, and durations
- **Memory Copy Events**: Reads memory transfer operations between agents with size and duration information
- **Sample Events**: Reads instantaneous sampling data from CPU/GPU tracks
- **Generic Events**: Fallback handling for unrecognized events
- **Automatic Detection**: Automatically detects ROCm profiler databases and handles different table naming schemes

## Requirements

- Python 3.7+
- babeltrace2 with Python bindings
- sqlite3 (standard library)

## Installation

1. Make sure you have babeltrace2 installed:
   ```bash
   # On Ubuntu/Debian
   sudo apt-get install babeltrace2 python3-bt2
   ```

2. Install Python dependencies:
   ```bash
   pip install -r requirements.txt
   ```

3. Place the plugin file (`bt_plugin_rocm.py`) in a directory where babeltrace2 can find it

## Usage

### Basic Usage

```bash
# Read a ROCm profiler database and display events
babeltrace2 --plugin-path=. --component source.rocm.RocmSource --params='db-path="your_rocm_database.db"'

# Convert to text format with pretty printing
babeltrace2 --plugin-path=. --component source.rocm.RocmSource --params='db-path="your_rocm_database.db"' --component sink.text.pretty

# Convert to CTF format
babeltrace2 --plugin-path=. --component source.rocm.RocmSource --params='db-path="your_rocm_database.db"' --component sink.ctf.fs --params='path="output_ctf_trace"'
```

### Python API Usage

```python
import bt2

# Create a plugin
plugin = bt2.find_plugin("rocm")
source_cc = plugin.source_component_classes["RocmSource"]

# Create a graph
graph = bt2.Graph()

# Add source component
source = graph.add_component(source_cc, "rocm_source", {
    "db-path": "/path/to/rocm_profile.db"
})

# Add sink component
sink_cc = bt2.find_plugin("text").sink_component_classes["pretty"]
sink = graph.add_component(sink_cc, "text_sink")

# Connect components
graph.connect_ports(source.output_ports["out"], sink.input_ports["in"])

# Run the graph
graph.run()
```

## Error Handling

The plugin handles various error conditions:

- **Missing database file**: Raises `FileNotFoundError`
- **Invalid database format**: Logs errors and continues with available data
- **Missing tables**: Gracefully handles missing optional tables
- **SQL errors**: Logs specific errors and continues processing

## Performance

- **Memory efficient**: Loads events in batches to handle large databases
- **Sorted output**: Events are sorted by timestamp for proper trace ordering
- **Database optimization**: Uses indexes for efficient querying

